import{aP as Ae,t as d,K,aQ as Be,aR as Fe,au as Ie}from"./lib.Cdm3KEls.js";import{h as $,E as q,k as C,v as N,R as Q,d as ce,l as Te,y as $e,D as T,c as z,o as R,m as x,az as Oe,n as J,e as G,F as Re,C as De,b as L,a0 as ae,w as O,t as U,aB as Ue,H as I,a as P,p as _,_ as de,aw as ie,L as te,aO as Ee}from"./framework.BMMljfWr.js";import"./commonjsHelpers.Cpj98o6Y.js";const Ve=v=>{const n=$({searchText:"",sortBy:"command",sortOrder:"asc"}),l=q([]),a=q([]),m=(S,M)=>{if(!M)return S;const e=M.toLowerCase().split(/\s+/);return S.map(t=>{const r=t.command.toLowerCase(),B=t.aliases.join(" ").toLowerCase();let F=0;return e.forEach(s=>{r===s?F+=5:r.startsWith(s)?F+=4:r.includes(s)?F+=3:t.aliases.some(f=>f.toLowerCase()===s)?F+=2:B.includes(s)&&(F+=1)}),{item:t,score:F}}).filter(({score:t})=>t>0).sort((t,r)=>{const B=r.score-t.score;return B!==0?B:t.item.command.localeCompare(r.item.command)}).map(({item:t})=>t)},u=S=>[...S].sort((M,e)=>{let t=0;if(n.value.sortBy==="command")t=M.command.localeCompare(e.command,void 0,{numeric:!0});else{const r=M.aliases[0]||"",B=e.aliases[0]||"";M.aliases.length===0&&e.aliases.length>0?t=1:M.aliases.length>0&&e.aliases.length===0?t=-1:t=r.localeCompare(B,void 0,{numeric:!0})}return n.value.sortOrder==="asc"?t:-t}),b=Ae(()=>{l.value=m(v.value,n.value.searchText),a.value=u(l.value)},200),h=C(()=>(b(),a.value)),k=C({get:()=>n.value.searchText,set:S=>{n.value.searchText=S,b()}}),o=C(()=>n.value.sortBy),y=C(()=>n.value.sortOrder),i=S=>{n.value.sortBy===S?n.value.sortOrder=n.value.sortOrder==="asc"?"desc":"asc":(n.value.sortBy=S,n.value.sortOrder="asc"),a.value=u(l.value)},c=()=>{n.value={searchText:"",sortBy:"command",sortOrder:"asc"},l.value=[],a.value=u(v.value)};return l.value=v.value,a.value=u(v.value),{searchText:k,filteredAliasList:h,sortBy:o,sortOrder:y,toggleSort:i,resetAll:c}},We=(v=50,n)=>{const l=q([]),a=q([]),m=i=>({aliasList:JSON.parse(JSON.stringify(i)),timestamp:Date.now()}),u=i=>{const c=m(i);l.value=[...l.value,c].slice(-v),a.value=[]},b=()=>{if(l.value.length===0)return;const i=m(n.value);a.value=[...a.value,i];const c=l.value.pop();c&&(n.value=JSON.parse(JSON.stringify(c.aliasList)))},h=()=>{if(a.value.length===0)return;const i=m(n.value);l.value=[...l.value,i];const c=a.value.pop();c&&(n.value=JSON.parse(JSON.stringify(c.aliasList)))},k=()=>{l.value=[],a.value=[]},o=C(()=>l.value.length>0),y=C(()=>a.value.length>0);return{addHistory:u,handleUndo:b,handleRedo:h,clearHistory:k,canUndo:o,canRedo:y}},ze=(v,n,l,a)=>{const m=K(),u=o=>o.length<1?{valid:!1,message:d("别名不能为空")}:o.length>50?{valid:!1,message:d("别名")+o+d("长度超过50个字符")}:/[<>:"\/\\|?*\x00-\x1F]/.test(o)?{valid:!1,message:d("别名")+o+d("包含无效字符")}:{valid:!0},b=(o,y)=>{const i=v.value.find(e=>e.id===o);if(!i)return{success:!1,message:d("找不到指定的命令")};const c=y.map(e=>e.trim()).filter(Boolean).map(e=>({alias:e,validation:u(e)})),S=c.filter(e=>!e.validation.valid).map(e=>e.validation.message);if(S.length>0)return{success:!1,message:S.join(`
`),type:"validation"};const M=c.map(e=>e.alias);for(const e of M)if(a(e,i.command)){for(const t of v.value)if(t.id!==o&&(t.command.toLowerCase()===e.toLowerCase()||t.aliases.some(r=>r.toLowerCase()===e.toLowerCase())))return{success:!1,message:`${d("别名")}"${e}"${d("已被命令")}"${t.command}"${d("使用")}`,type:"conflict"}}try{return l(v.value),n(o,M),{success:!0}}catch(e){return console.error("更新别名失败:",e),{success:!1,message:d("更新失败，请重试"),type:"error"}}};return{handleUpdateAlias:b,handleRemoveAlias:(o,y)=>{const i=v.value.find(c=>c.id===o);if(!i)return m.error(d("找不到指定的命令")),!1;try{return l(v.value),n(o,i.aliases.filter(c=>c!==y)),!0}catch(c){return console.error("删除别名失败:",c),m.error(d("删除失败，请重试")),!1}},handleBatchUpdate:o=>{const y={success:[],failed:[]};for(const i of o){const c=b(i.id,i.aliases);c.success?y.success.push(i.id):y.failed.push({id:i.id,message:c.message||d("更新失败")})}return y},validateAlias:u}},Le=(v,n,l)=>{const a=$({searchInputMap:{},menuModeMap:{},expandedMap:{},aliasFilterMap:{},focusedId:null}),m=()=>{const e=new Set(v.value.map(r=>r.id)),t={...a.value};for(const r of Object.keys(t.searchInputMap))e.has(r)||delete t.searchInputMap[r];for(const r of Object.keys(t.menuModeMap))e.has(r)||delete t.menuModeMap[r];for(const r of Object.keys(t.expandedMap))e.has(r)||delete t.expandedMap[r];for(const r of Object.keys(t.aliasFilterMap))e.has(r)||delete t.aliasFilterMap[r];a.value=t};N(()=>v.value,()=>{Q(m)},{deep:!0});const u=e=>{a.value.focusedId=e,n(e)&&(a.value.menuModeMap[e]=!0)},b=e=>{setTimeout(()=>{a.value.focusedId===e&&(a.value.focusedId=null),a.value.searchInputMap[e]||(a.value.menuModeMap[e]=!1)},200)},h=e=>{var r;if(l.value){a.value.expandedMap[e]=!a.value.expandedMap[e];return}const t=(r=Object.entries(a.value.expandedMap).find(([B,F])=>F))==null?void 0:r[0];if(a.value.expandedMap[e]){a.value.expandedMap[e]=!1;return}t&&(a.value.expandedMap[t]=!1),a.value.expandedMap[e]=!0},k=(e,t)=>{a.value.aliasFilterMap[e]=t,t&&(a.value.expandedMap[e]=!0)},o=e=>{a.value.searchInputMap[e]="",a.value.menuModeMap[e]=!1,a.value.aliasFilterMap[e]=""},y=C({get:()=>a.value.searchInputMap,set:e=>a.value.searchInputMap=e}),i=C({get:()=>a.value.menuModeMap,set:e=>a.value.menuModeMap=e}),c=C({get:()=>{const e={...a.value.expandedMap};return v.value.forEach(t=>{typeof e[t.id]!="boolean"&&(e[t.id]=!1)}),e},set:e=>a.value.expandedMap=e}),S=C({get:()=>{const e={...a.value.aliasFilterMap};return v.value.forEach(t=>{e[t.id]||(e[t.id]="")}),e},set:e=>a.value.aliasFilterMap=e});return{searchInputMap:y,menuModeMap:i,expandedMap:c,aliasFilterMap:S,handleClear:o,handleFocus:u,handleBlur:b,toggleExpand:h,setAliasFilter:k,resetState:()=>{a.value={searchInputMap:{},menuModeMap:{},expandedMap:{},aliasFilterMap:{},focusedId:null}}}},{isShow:Ne,showDialog:se}=Be,je=()=>{const v=$(),n=$(!1),l=K(),a=async h=>{n.value=!0;try{await h()}catch(k){console.error("操作失败:",k),l.error(d("操作失败，请重试"))}finally{n.value=!1}},m=()=>{var h;return(h=v.value)==null?void 0:h.click()};return{isShow:Ne,showDialog:se,fileInput:v,loading:n,handleImport:m,handleFileSelect:async(h,k)=>{const o=h.target.files;o!=null&&o[0]&&(await a(async()=>{await k(o[0])}),v.value&&(v.value.value=""))},createFooterBtnList:(h,k,o,y)=>[{name:d("保存"),fun:async()=>{await a(async()=>{await h(),y.value=!y.value,se(!1)})},primary:!0},{name:d("恢复默认"),fun:()=>{k()}},{name:d("导出"),fun:o},{name:d("导入"),fun:m},{name:d("取消"),fun:()=>{se(!1)}}],withLoading:a}},He={class:"alias-cell"},Je={class:"alias-container"},Pe={class:"chips-container"},Ke=["title"],qe={key:0,class:"more-hint"},Qe={class:"expanded-wrapper"},Ge={class:"expanded-content"},Xe={class:"alias-input"},Ye=["title"],Ze=ce({__name:"AliasCell",props:{item:{},expanded:{type:Boolean},filterText:{}},emits:["update:aliases","remove","toggle-expand","update:filterText","show-error"],setup(v,{emit:n}){const l=v,a=n,m=C(()=>Math.floor(552/100)),u=$(""),b=$(!1),h=$(!1),k=C(()=>l.filterText?l.item.aliases.filter(s=>{var f;return s.toLowerCase().includes(((f=l.filterText)==null?void 0:f.toLowerCase())||"")}):l.item.aliases),o=C(()=>{const s=l.filterText?k.value:l.item.aliases;return l.expanded||s.length<=m.value?s:s.slice(0,m.value)}),y=C(()=>k.value.length>m.value),i=C(()=>{const s=k.value.length,f=l.expanded?s:Math.min(s,m.value);return s-f}),c=C(()=>!!(b.value||l.filterText||u.value.trim()));N(c,s=>{s&&!l.expanded&&a("toggle-expand")});const S=s=>{var A;s.target.closest(".v-chip__close, .add-btn, .v-field__input")||(A=window.getSelection())!=null&&A.toString()||a("toggle-expand")},M=()=>{const s=u.value.trim();if(!s)return;const f=s.split(/[\s,]+/).map(A=>A.trim()).filter(A=>A&&!l.item.aliases.includes(A));if(f.length===0){a("show-error",d("别名已存在"));return}a("update:aliases",[...l.item.aliases,...f]),u.value="",Q(()=>{var A;(A=B.value)==null||A.focus({preventScroll:!0})})};C(()=>u.value.trim()?d("按回车添加，支持空格或逗号分隔多个别名"):d("输入新别名"));const e=s=>{s.key==="Enter"?(s.preventDefault(),M()):s.key==="Escape"?(s.preventDefault(),u.value="",h.value=!1,s.target.blur()):s.key==="Tab"?u.value.trim()||(s.preventDefault(),a("toggle-expand")):s.key===","&&(s.preventDefault(),M())},t=()=>{b.value=!0,h.value=!0},r=()=>{b.value=!1,setTimeout(()=>{h.value=!1},200)},B=$();N(()=>l.expanded,s=>{s&&Q(()=>{var f;(f=B.value)==null||f.focus({preventScroll:!0})})});const F=s=>{if(l.expanded){const f=s.target,A=f.closest(".alias-cell");f.closest(".v-dialog")&&!A&&a("toggle-expand")}};return Te(()=>{document.addEventListener("click",F)}),$e(()=>{document.removeEventListener("click",F)}),N(u,s=>{s.trim()&&(h.value=!0)},{immediate:!0}),C(()=>Math.floor(768/150)),(s,f)=>{const A=T("v-chip"),W=T("v-icon"),j=T("v-btn"),X=T("v-text-field");return R(),z("div",He,[x("div",{class:J(["alias-content",{"is-expanded":s.expanded}]),onClick:ae(S,["stop"])},[x("div",Je,[x("div",{class:J(["chips-wrapper",{"has-focus":b.value,"has-many":s.item.aliases.length>m.value,clickable:!s.expanded&&s.item.aliases.length>0}])},[x("div",Pe,[(R(!0),z(Re,null,De(o.value,D=>(R(),L(A,{key:D,size:"x-small",closable:s.expanded,class:J(["ma-1",{highlight:u.value===D}]),"onClick:close":ae(le=>a("remove",D),["stop"])},{default:O(()=>[x("span",{class:"alias-text",title:D},U(D),9,Ke)]),_:2},1032,["closable","onClick:close","class"]))),128))]),!s.expanded&&y.value?(R(),z("span",qe," +"+U(i.value),1)):G("",!0)],2)]),Oe(x("div",Qe,[x("div",Ge,[x("div",Xe,[I(X,{ref_key:"inputRef",ref:B,modelValue:u.value,"onUpdate:modelValue":f[0]||(f[0]=D=>u.value=D),placeholder:_(d)("输入新别名"),onKeydown:e,onFocus:t,onBlur:r},{append:O(()=>[I(j,{color:"primary",variant:"text",size:"small",onClick:ae(M,["stop"]),disabled:!u.value.trim(),class:"add-btn"},{default:O(()=>[I(W,{start:"",size:"small",icon:"$mdi-plus"}),P(" "+U(_(d)("添加")),1)]),_:1},8,["disabled"])]),_:1},8,["modelValue","placeholder"])]),!s.expanded&&i.value>0?(R(),z("span",{key:0,class:"more-hint",title:_(d)("还有 {0} 个别名",[i.value])}," +"+U(i.value),9,Ye)):G("",!0)])],512),[[Ue,s.expanded]])],2)])}}}),ea=de(Ze,[["__scopeId","data-v-fd9e1ebb"]]),aa={class:"alias-dialog"},ta={class:"search-bar mb-2"},sa={class:"d-flex align-center gap-2 ml-4"},la={class:"grid-container"},na={class:"grid-header"},oa={class:"grid-body custom-scrollbar"},ra={key:0,class:"empty-state"},ia={class:"mt-2"},ca=["onClick"],da={class:"command-cell"},ua={class:"alias-cell"},pa=ce({__name:"index",setup(v){const{aliasList:n,initData:l,updateAlias:a,saveConfig:m,resetToDefault:u,exportConfig:b,importConfig:h,checkConflict:k}=Fe(),{isShow:o,showDialog:y,fileInput:i,handleFileSelect:c,createFooterBtnList:S}=je(),M=$(!1),e=S(m,u,b,M),{searchText:t,filteredAliasList:r,sortBy:B,sortOrder:F,toggleSort:s,resetAll:f}=Ve(n),{addHistory:A,handleUndo:W,handleRedo:j,canUndo:X,canRedo:D}=We(50,n),{handleUpdateAlias:le,handleRemoveAlias:ue}=ze(n,a,A,k),pe={"ctrl + z":W,"ctrl + y":j,"ctrl + s":async()=>{try{await m(),M.value=!M.value,y(!1)}catch(p){console.error("保存失败:",p)}}},ve=C(()=>({height:400,itemHeight:32,items:r.value})),Y=$(null),fe=p=>{Y.value=p.id},me=p=>{const w=n.value.find(E=>E.id===p);return w?w.aliases.length>3:!1};N(()=>n.value,()=>{Q(()=>{ge.value={}})},{deep:!0});const H=$(!1);(async()=>{H.value=!0;try{await l(),f(),Y.value=null,Z.success(d("加载成功"))}catch(p){console.error("初始化失败:",p),Z.error(d("加载失败"))}finally{H.value=!1}})();const Z=K(),he=p=>{c(p,h)},{menuModeMap:ge,expandedMap:_e,aliasFilterMap:xe,toggleExpand:ye,setAliasFilter:Me}=Le(n,me,t),we=p=>({"table-row":!0,"is-highlighted":p.id===Y.value,"has-aliases":p.aliases.length>0}),ne=p=>{(p==="command"||p==="aliases")&&s(p)},Ce=(p,w)=>{const E=le(p,w);!E.success&&E.message&&K().error(E.message)};return(p,w)=>{const E=T("v-progress-circular"),ke=T("v-overlay"),Se=T("v-text-field"),oe=T("v-btn"),re=T("v-tooltip"),ee=T("v-icon"),be=T("v-virtual-scroll");return R(),L(Ie,{title:p.t("CAD快捷键设置"),modelValue:_(o),"onUpdate:modelValue":w[4]||(w[4]=g=>ie(o)?o.value=g:null),maxWidth:"800",footerBtnList:_(e),keys:pe},{default:O(()=>[x("div",aa,[I(ke,{modelValue:H.value,"onUpdate:modelValue":w[0]||(w[0]=g=>H.value=g),class:"align-center justify-center"},{default:O(()=>[I(E,{indeterminate:""})]),_:1},8,["modelValue"]),x("div",ta,[I(Se,{modelValue:_(t),"onUpdate:modelValue":w[1]||(w[1]=g=>ie(t)?t.value=g:null),placeholder:p.t("搜索命令或别名..."),"prepend-inner-icon":"$mdi-magnify",class:"flex-grow-1",clearable:""},null,8,["modelValue","placeholder"]),x("div",sa,[I(re,{text:p.t("撤销"),location:"top"},{activator:O(({props:g})=>[I(oe,te(g,{icon:"houtui",disabled:!_(X),onClick:_(W),variant:"text",size:"32"}),null,16,["disabled","onClick"])]),_:1},8,["text"]),I(re,{text:p.t("重做"),location:"top"},{activator:O(({props:g})=>[I(oe,te(g,{icon:"qianjin",disabled:!_(D),onClick:_(j),variant:"text",size:"32"}),{append:O(()=>[...w[5]||(w[5]=[])]),_:1},16,["disabled","onClick"])]),_:1},8,["text"])])]),x("div",la,[x("div",na,[x("div",{class:"command-header text-center",onClick:w[2]||(w[2]=g=>ne("command"))},[P(U(p.t("命令"))+" ",1),_(B)==="command"?(R(),L(ee,{key:0,size:"20",icon:_(F)==="asc"?"$mdi-arrow-up":"$mdi-arrow-down",color:"primary",class:"ml-1"},null,8,["icon"])):G("",!0)]),x("div",{class:"alias-header text-center",onClick:w[3]||(w[3]=g=>ne("aliases"))},[P(U(p.t("别名"))+" ",1),_(B)==="aliases"?(R(),L(ee,{key:0,size:"20",icon:_(F)==="asc"?"$mdi-arrow-up":"$mdi-arrow-down",color:"primary",class:"ml-1"},null,8,["icon"])):G("",!0)])]),x("div",oa,[_(r).length===0?(R(),z("div",ra,[I(ee,{size:"48",color:"grey"},{default:O(()=>[...w[6]||(w[6]=[P("$mdi-magnify",-1)])]),_:1}),x("p",ia,U(p.t("没有找到匹配的命令或别名")),1)])):(R(),L(be,Ee(te({key:1},ve.value)),{default:O(({item:g})=>[x("div",{class:J(["grid-row",we(g)]),onClick:V=>fe(g)},[x("div",da,U(g.command),1),x("div",ua,[I(ea,{item:g,expanded:!!_(_e)[g.id],filterText:_(xe)[g.id],"onUpdate:filterText":V=>_(Me)(g.id,V),"onUpdate:aliases":V=>Ce(g.id,V),onRemove:V=>_(ue)(g.id,V),onToggleExpand:V=>_(ye)(g.id),onShowError:_(Z).error},null,8,["item","expanded","filterText","onUpdate:filterText","onUpdate:aliases","onRemove","onToggleExpand","onShowError"])])],10,ca)]),_:1},16))])])]),x("input",{type:"file",ref_key:"fileInput",ref:i,accept:".json",style:{display:"none"},onChange:he},null,544)]),_:1},8,["title","modelValue","footerBtnList"])}}}),ga=de(pa,[["__scopeId","data-v-d14f7f9d"]]);export{ga as default};
