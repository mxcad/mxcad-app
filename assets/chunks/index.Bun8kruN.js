import{h as O,v as He,d as We,D as I,c as Me,o as Se,H as d,w as i,m as w,t as v,F as Te,C as Ye,p as u,az as Xe,aH as Ne,a as k,aw as B,L as _e}from"./framework.BMMljfWr.js";import{b1 as $e,b_ as T,b as H,t as F,m as b,W as Ge,Y as P,j as Ae,k as ke,v as Pe,F as Je,K as Z,G as Le,H as Ke,b$ as qe,c as Qe,a as Ze,au as Ee,ax as Ue,aw as ze,aG as ie,bb as fe}from"./lib.Cdm3KEls.js";import{p as et}from"./print.C1A5-esz.js";import{i as tt}from"./identificationFrame.BLc_5W26.js";import"./commonjsHelpers.Cpj98o6Y.js";function Oe(y,_,D,M){const S=Math.abs(M.x-D.x),L=Math.abs(M.y-D.y);let g;return y/S<_/L?g=S/y:g=L/_,g}function at(y,_,D,M,S){const L=y*S,g=_*S,R=(D.x+M.x)/2,W=(D.y+M.y)/2,z=new b(R-L/2,W+g/2),C=new b(R+L/2,W-g/2);return[z,C]}const lt=()=>{const y=O(!0),_=O(0),D=O(0),M=O(0),S=O(0),L=["A1","A2","A3","A4","自定义16.55x23.90"],g=O("A4"),R=()=>{switch(g.value){case"A1":return{w:594,h:841};case"A2":return{w:420,h:594};case"A3":return{w:297,h:420};case"A4":return{w:210,h:297};case"自定义16.55x23.90":return{w:165.5,h:239,nw:130,nh:190}}},W=["横向","纵向"],z=O("横向"),C=O(1),U=O(1);let $,ae,ee=U.value/C.value;const ue=()=>{let{w:a,h:t}=R();const e=U.value/C.value;if(Math.abs(e-ee)<1e-6)return;ee=e;const[l,n]=at(a,t,$,ae,e);_.value=P((l==null?void 0:l.x)||0,4),D.value=P((l==null?void 0:l.y)||0,4),M.value=P((n==null?void 0:n.x)||0,4),S.value=P((n==null?void 0:n.y)||0,4),x.pt1=l,x.pt2=n,x.w=a,x.h=t},ve=()=>{let{w:a,h:t}=R();const e=Oe(a,t,$,ae);ee=e,U.value=P(C.value*e,4),ue()},le=[];let x;const Y=(a,t)=>{$=a,ae=t;let{w:e,h:l,nw:n,nh:m}=R();if(z.value==="横向"){let E=e;e=l,l=E,E=n,n=m,m=E}x&&le.push(x);const f=Oe(e,l,a,t);return ee=f,U.value=P(C.value*f,4),x={pt1:a,pt2:t,w:e,h:l,size:g.value,paperOrientation:z.value,printParameterMillimeter:C.value,printParametersCADDrawingUnits:U.value,isDrawingBoundary:y.value},_.value=P((a==null?void 0:a.x)||0,4),D.value=P((a==null?void 0:a.y)||0,4),M.value=P((t==null?void 0:t.x)||0,4),S.value=P((t==null?void 0:t.y)||0,4),x},de=()=>{const{minPt:a,maxPt:t}=H.getCurrentDatabase().currentSpace.getBoundingBox();return Y(a,t)},we=()=>{const{pt1:a,pt3:t}=H.getCurrentMxCAD().getViewCADCoord();return Y(a,t)},he=()=>{typeof y.value=="boolean"&&(y.value?de():we())},ye=()=>{const a=le.pop();if(!a)return Z().error(F("没有历史记录"));const{pt1:t,pt2:e,size:l}=a;return x=a,_.value=P((t==null?void 0:t.x)||0,4),D.value=P((t==null?void 0:t.y)||0,4),M.value=P((e==null?void 0:e.x)||0,4),S.value=P((e==null?void 0:e.y)||0,4),g.value=l,z.value=a.paperOrientation,C.value=a.printParameterMillimeter,U.value=a.printParametersCADDrawingUnits,y.value=a.isDrawingBoundary,y.value=null,Z().success(F("已选择上次范围"))},ge=async()=>{T.isShow.value=!1;const a=()=>{T.isShow.value=!0},t=new Ae;t.clearLastInputPoint(),t.setMessage(`
`+F("指定输出范围第一点")+":"),t.disableAllTrace();let e=await t.go();if(!e)return a();t.setMessage(`
`+F("指定输出范围第二点")+":"),t.setUserDraw((n,m)=>{if(!e)return;m.setColor(16711680);let p=new ke;p.addVertexAt(e),p.addVertexAt(new b(e.x,n.y)),p.addVertexAt(n),p.addVertexAt(new b(n.x,e.y)),p.constantWidth=Pe.screenCoordLong2Doc(2),p.isClosed=!0,m.drawMcDbEntity(p);let f=[];f.push(e.toVector3()),f.push(new THREE.Vector3(e.x,n.y)),f.push(n.toVector3()),f.push(new THREE.Vector3(n.x,e.y)),m.setColor(12868),m.drawSolid(f,.5)}),t.setDisableOsnap(!0),t.setDisableOrthoTrace(!0),t.setDynamicInputType(Le.kXYCoordInput);let l=await t.go();if(!l)return a();Y(e,l),y.value=null,T.isShow.value=!0,Z().success(F("指定输出范围成功"))},oe=async()=>{function a(s,h,c,A){const N=Math.abs(A.x-c.x),j=Math.abs(A.y-c.y);let q;N>j?q=N/s:q=j/h;const Q=s*q,me=h*q;return new b(c.x+Q,c.y-me)}T.isShow.value=!1;const t=()=>{T.isShow.value=!0},e=new Ae;e.clearLastInputPoint(),e.setMessage(`
`+F("指定打印范围第一点")+":"),e.disableAllTrace();let{w:l,h:n,nw:m,nh:p}=R();const f=U.value/C.value;(s=>{if(l=l*s,n=n*s,m&&(m=m*s),p&&(p=p*s),z.value==="横向"){let c=l;l=n,n=c,c=m,m=p,p=c}})(f);let V=await e.go();if(!V)return t();e.setMessage(`
`+F("指定打印范围第二点")+":"),e.setUserDraw((s,h)=>{if(!V)return;h.setColor(16711680),s=a(l,n,V,s);let c=new ke;c.addVertexAt(V),c.addVertexAt(new b(V.x,s.y)),c.addVertexAt(s),c.addVertexAt(new b(s.x,V.y)),c.constantWidth=Pe.screenCoordLong2Doc(2),c.isClosed=!0,h.drawMcDbEntity(c);let A=[];A.push(V.toVector3()),A.push(new THREE.Vector3(V.x,s.y)),A.push(s.toVector3()),A.push(new THREE.Vector3(s.x,V.y)),h.setColor(12868),h.drawSolid(A,.5)}),e.setDisableOsnap(!0),e.setDisableOrthoTrace(!0),e.setDynamicInputType(Le.kXYCoordInput);let X=await e.go();if(!X)return t();X=a(l,n,V,X),Y(V,X),y.value=null,T.isShow.value=!0,Z().success(F("指定输出范围成功"))},Ce=async()=>{T.isShow.value=!1;const a=U.value/C.value;let{w:t,h:e,nw:l,nh:n}=R();(s=>{if(t=t*s,e=e*s,l&&(l=l*s),n&&(n=n*s),z.value==="横向"){let c=t;t=e,e=c,c=l,l=n,n=c}})(a);const p=new Ae;p.clearLastInputPoint(),p.disableAllTrace(),p.setMessage(`
`+F("指定指定打印中心位置")),p.setKeyWords("");const f=H.getCurrentMxCAD();p.setUserDraw((s,h)=>{h.setColor(16711680);let c=new ke,A=s.clone(),N=new b(s.x,s.y+e),j=new b(s.x+t,s.y+e),q=new b(s.x+t,s.y);c.addVertexAt(A),c.addVertexAt(N),c.addVertexAt(j),c.addVertexAt(q),c.constantWidth=Pe.screenCoordLong2Doc(2),c.isClosed=!0,h.drawMcDbEntity(c);let Q=[];if(Q.push(A.toVector3()),Q.push(N.toVector3()),Q.push(j.toVector3()),Q.push(q.toVector3()),h.setColor(12868),h.drawSolid(Q,.5),l&&n&&l>0&&n>0){let me=s.clone(),Fe=new b(s.x,s.y+e),Be=new b(s.x+t,s.y+e),je=new b(s.x+t,s.y),te=[];te.push(me.toVector3()),te.push(Fe.toVector3()),te.push(Be.toVector3()),te.push(je.toVector3()),te.push(me.toVector3());let Re=f.mxdraw.viewCoordLong2Cad(3),Ie=Je.createDashedLines(te,16777215,Re*2,Re);h.drawEntity(Ie)}});let E=await p.go();if(!E)return T.isShow.value=!0;let V=E.clone(),X=new b(E.x+t,E.y+e);Y(V,X),T.isShow.value=!0,y.value=null,Z().success(F("指定输出范围成功"))},ne=(a,t,e,l,n=!1)=>new Promise(m=>{let p=H.getCurrentMxCAD(),f={width:""+e,height:""+l,roate_angle:0,bd_pt1_x:""+a.x,bd_pt1_y:""+a.y,bd_pt2_x:""+t.x,bd_pt2_y:""+t.y};p.database.isCurrentModelSpace||(f.layout_name=p.getCurrentLayout(),f.create_clip_block=!1);const E=Ze(),V=()=>{E&&Qe("MxFullScreen")};{let{baseUrl:X="",mxfilepath:s="",printPdfUrl:h=""}=Ke()||{};H.getCurrentMxCAD().saveFileToUrl(h,(c,A)=>{try{let N=JSON.parse(A);if(N.ret=="ok"){let j=X+s+N.file;if(n)return m(j);et(j),V(),Z().success(F("打印成功")),m(j)}else console.log(A),Z().error(F("打印失败")),m(!1)}catch{console.log("Mx: sserverResult error"),m(!1)}},void 0,JSON.stringify(f))}}),se=()=>{const{pt1:a,pt2:t,w:e,h:l}=x||de();ne(a,t,e,l),T.isShow.value=!1},xe=(a,t,e=16711680)=>{const l=new qe;return l.pt1=a.toVector3(),l.pt2=t.toVector3(),l.setLineWidth(10),l.color=e,l.top(),l},G=$e(!1,"Mx_batch_PrintDialog");let J=[];const o=O([]);let r=[];const re=async()=>{T.isShow.value=!1,G.isShow.value=!1,r=await tt(),o.value=r.map((a,t)=>({name:F("图框")+t,index:t})),J=r.filter(a=>!!a).map((a,t)=>{const{minPt:e,maxPt:l}=a,n=xe(e,l),m=H.getCurrentMxCAD();m.getMxDrawObject().addMxEntity(n);const p=new b((e.x+l.x)/2,(e.y+l.y)/2),f=new Ge;return f.text=t.toString(),f.position=p.toVector3(),f.color=16711680,f.height=e.distanceTo(l)*.5,m.getMxDrawObject().addMxEntity(f),[f,n]}),G.isShow.value=!0};function Ve(a,t){var e=document.createElement("a");e.setAttribute("href",a),e.setAttribute("download",t),document.body.appendChild(e),e.click(),document.body.removeChild(e)}const ce=async()=>{let{w:a,h:t}=R();for(let e=0;e<r.length;e++){const{minPt:l,maxPt:n}=r[e]||{};if(!l||!n)continue;const m=await ne(l,n,a,t,!0);m&&Ve(m,o.value[e].name)}G.isShow.value=!1},pe=()=>{const a=H.getCurrentMxCAD();J.forEach(([t,e])=>{a.mxdraw.eraseMxEntity(t.objectId()),a.mxdraw.eraseMxEntity(e.objectId())}),J=[],r=[],o.value=[],a.updateDisplay()};return He(G.isShow,a=>{a||pe()}),{dialog:T,isDrawingBoundary:y,lowerLeftCornerCoordinateX:_,lowerLeftCornerCoordinateY:D,upperRightCornerCoordinateX:M,upperRightCornerCoordinateY:S,sheetSizes:L,sheetSize:g,paperOrientations:W,paperOrientation:z,printParameterMillimeter:C,printParametersCADDrawingUnits:U,scopeHistory:le,callLastTimeScopeHistory:ye,callFreeChoiceOfRange:ge,callFixedProportionalSelection:oe,callFixedDrawingSizeSelection:Ce,callPrint:se,updateDrawingBoundary:he,updatePrintParameters:ue,updateSize:ve,universalBatchPrinting:ce,frameIndexArr:o,removeFrame:a=>{const[t,e]=J[a],l=H.getCurrentMxCAD();l.mxdraw.eraseMxEntity(t.objectId()),l.mxdraw.eraseMxEntity(e.objectId()),l.updateDisplay(),r.splice(a,1),J.splice(a,1),o.value.splice(a,1)},removeFramesRectBoxArr:pe,frameRecognition:re,batchPrintingDialog:G,framePrint:a=>{if(!r[a])return;const{maxPt:t,minPt:e}=r[a];let{w:l,h:n}=R();ne(e,t,l,n,!0)},positioningFrame:a=>{if(!r[a])return;let{maxPt:t,minPt:e}=r[a];const l=H.getCurrentMxCAD(),n=e.distanceTo(t)*.1;t=t.clone(),e=e.clone(),e.x-=n,e.y-=n,t.x+=n,t.y+=n,l.zoomW(e,t)}}},ot=["onUpdate:modelValue"],nt={class:"d-flex flex-column"},st={class:"h-100 mt-2"},rt={class:"d-flex align-center flex-column"},mt=We({__name:"index",setup(y){const{dialog:_,isDrawingBoundary:D,lowerLeftCornerCoordinateX:M,lowerLeftCornerCoordinateY:S,upperRightCornerCoordinateX:L,upperRightCornerCoordinateY:g,sheetSizes:R,sheetSize:W,paperOrientations:z,paperOrientation:C,printParameterMillimeter:U,printParametersCADDrawingUnits:$,callLastTimeScopeHistory:ae,callFreeChoiceOfRange:ee,callFixedProportionalSelection:ue,callFixedDrawingSizeSelection:ve,callPrint:le,updateDrawingBoundary:x,updatePrintParameters:Y,updateSize:de,universalBatchPrinting:we,frameIndexArr:he,removeFrame:ye,frameRecognition:ge,batchPrintingDialog:oe,framePrint:Ce,positioningFrame:ne}=lt(),{isShow:se,showDialog:xe}=_,G=[{name:"生成打印PDF",fun:le,primary:!0},{name:"取消",fun:()=>xe(!1)}],J=[{name:"批量下载",fun:we,primary:!0},{name:"取消",fun:()=>oe.showDialog(!1)}];return(o,r)=>{const re=I("v-btn"),Ve=I("v-table"),ce=I("v-radio"),pe=I("v-radio-group"),K=I("v-text-field"),be=I("v-col"),De=I("v-list-item"),a=I("v-select"),t=I("v-row");return Se(),Me(Te,null,[d(Ee,{title:o.t("图框识别批量打印"),modelValue:u(oe).isShow.value,"onUpdate:modelValue":r[0]||(r[0]=e=>u(oe).isShow.value=e),"max-width":"600",footerBtnList:J},{default:i(()=>[d(Ve,{density:"compact","fixed-header":"",height:300,class:"attribute_table",style:{"table-layout":"fixed"}},{default:i(()=>[w("thead",null,[w("tr",null,[w("th",null,"pdf"+v(o.t("名称")),1),w("th",null,v(o.t("操作")),1)])]),w("tbody",null,[(Se(!0),Me(Te,null,Ye(u(he),(e,l)=>(Se(),Me("tr",{key:l},[w("td",null,[Xe(w("input",{class:"w-100 h-100","onUpdate:modelValue":n=>e.name=n},null,8,ot),[[Ne,e.name]])]),w("td",null,[d(re,{onClick:n=>u(ye)(l)},{default:i(()=>[k(v(o.t("删除")),1)]),_:1},8,["onClick"]),d(re,{onClick:n=>u(Ce)(l),class:"ml-1"},{default:i(()=>[k(v(o.t("打印")),1)]),_:1},8,["onClick"]),d(re,{onClick:n=>u(ne)(l),class:"ml-1"},{default:i(()=>[k(v(o.t("定位")),1)]),_:1},8,["onClick"])])]))),128))])]),_:1})]),_:1},8,["title","modelValue"]),d(Ee,{title:o.t("打印"),modelValue:u(se),"onUpdate:modelValue":r[10]||(r[10]=e=>B(se)?se.value=e:null),"max-width":"600",footerBtnList:G},{default:i(()=>[d(t,{align:"stretch"},{default:i(()=>[d(be,{cols:"6","align-self":"start"},{default:i(()=>[d(Ue,{title:o.t("打印区域"),class:"mt-2"},{default:i(()=>[d(pe,{modelValue:u(D),"onUpdate:modelValue":[r[1]||(r[1]=e=>B(D)?D.value=e:null),u(x)],inline:!1},{default:i(()=>[d(ce,{value:!0,onClick:u(x)},{label:i(()=>[d(ze,{class:"","key-name":"W"},{default:i(()=>[k(v(o.t("图纸")+o.t("界限")),1)]),_:1})]),_:1},8,["onClick"]),d(ce,{class:"mt-1",value:!1,onClick:u(x)},{label:i(()=>[d(ze,{class:"","key-name":"R"},{default:i(()=>[k(v(o.t("显示")+o.t("区域")),1)]),_:1})]),_:1},8,["onClick"])]),_:1},8,["modelValue","onUpdate:modelValue"]),w("div",nt,[d(ie,{class:"mt-2",onClick:u(ae)},{default:i(()=>[k(v(o.t("上次")+o.t("范围")),1)]),_:1},8,["onClick"]),d(ie,{class:"mt-1",onClick:u(ee)},{default:i(()=>[k(v(o.t("自由")+o.t("选择")),1)]),_:1},8,["onClick"]),d(ie,{class:"mt-1",onClick:u(ue)},{default:i(()=>[k(v(o.t("固定")+o.t("比例")+o.t("选择")),1)]),_:1},8,["onClick"]),d(ie,{class:"mt-1",onClick:u(ve)},{default:i(()=>[k(v(o.t("固定")+o.t("图纸")+o.t("大小")+o.t("选择")),1)]),_:1},8,["onClick"]),d(ie,{class:"mt-1",onClick:u(ge)},{default:i(()=>[k(v(o.t("图框识别")+" "+o.t("批量打印")),1)]),_:1},8,["onClick"])]),d(K,{modelValue:u(M),"onUpdate:modelValue":r[2]||(r[2]=e=>B(M)?M.value=e:null),class:"mt-2",type:"number"},{prepend:i(()=>[w("span",null,v(o.t("左下")+o.t("角")+o.t("坐标"))+"X:",1)]),_:1},8,["modelValue"]),d(K,{modelValue:u(S),"onUpdate:modelValue":r[3]||(r[3]=e=>B(S)?S.value=e:null),class:"mt-1",type:"number"},{prepend:i(()=>[w("span",null,v(o.t("左下")+o.t("角")+o.t("坐标"))+"Y:",1)]),_:1},8,["modelValue"]),d(K,{modelValue:u(L),"onUpdate:modelValue":r[4]||(r[4]=e=>B(L)?L.value=e:null),class:"mt-1",type:"number"},{prepend:i(()=>[w("span",null,v(o.t("右上")+o.t("角")+o.t("坐标"))+"X:",1)]),_:1},8,["modelValue"]),d(K,{modelValue:u(g),"onUpdate:modelValue":r[5]||(r[5]=e=>B(g)?g.value=e:null),class:"mt-1",type:"number"},{prepend:i(()=>[w("span",null,v(o.t("右上")+o.t("角")+o.t("坐标"))+"Y:",1)]),_:1},8,["modelValue"])]),_:1},8,["title"])]),_:1}),d(be,{cols:"6","align-self":"start"},{default:i(()=>[w("div",st,[d(Ue,{title:o.t("图纸")+o.t("尺寸")},{default:i(()=>[d(a,{modelValue:u(W),"onUpdate:modelValue":[r[6]||(r[6]=e=>B(W)?W.value=e:null),u(de)],items:u(R),class:"mr-1 my-2"},{prepend:i(()=>[w("span",null,v(o.t("图纸")+o.t("大小"))+":",1)]),selection:i(({item:e})=>[k(v(u(fe)(e.title)),1)]),item:i(({item:e,props:l})=>[d(De,_e(l,{title:u(fe)(e.title)}),null,16,["title"])]),_:1},8,["modelValue","items","onUpdate:modelValue"]),d(a,{modelValue:u(C),"onUpdate:modelValue":[r[7]||(r[7]=e=>B(C)?C.value=e:null),u(x)],items:u(z),class:"mr-1 my-2"},{prepend:i(()=>[w("span",null,v(o.t("图纸")+o.t("方向"))+":",1)]),selection:i(({item:e})=>[k(v(u(fe)(e.title)),1)]),item:i(({item:e,props:l})=>[d(De,_e(l,{title:u(fe)(e.title)}),null,16,["title"])]),_:1},8,["modelValue","items","onUpdate:modelValue"])]),_:1},8,["title"]),d(Ue,{class:"my-4 py-4",title:o.t("打印")+o.t("参数")},{default:i(()=>[w("div",rt,[d(K,{modelValue:u(U),"onUpdate:modelValue":r[8]||(r[8]=e=>B(U)?U.value=e:null),modelModifiers:{lazy:!0},min:"0","onUpdate:focused":u(Y),class:"w-75 mr-1",type:"number"},{append:i(()=>[k(v(o.t("毫米")),1)]),_:1},8,["modelValue","onUpdate:focused"]),r[11]||(r[11]=w("span",null,"=",-1)),d(K,{modelValue:u($),"onUpdate:modelValue":r[9]||(r[9]=e=>B($)?$.value=e:null),modelModifiers:{lazy:!0},min:"0","onUpdate:focused":u(Y),class:"w-75 ml-1 mr-1",type:"number"},{append:i(()=>[k(v("CAD"+o.t("绘图")+o.t("单位")),1)]),_:1},8,["modelValue","onUpdate:focused"])])]),_:1},8,["title"])])]),_:1})]),_:1})]),_:1},8,["title","modelValue"])],64)}}});export{mt as default};
