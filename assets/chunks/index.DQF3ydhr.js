import{h as w,k as X,d as ie,v as Y,D as P,aA as ce,b as re,o as U,az as ue,e as Z,p as e,c as Q,m as h,H as f,t as b,w as y,a as B,$ as ee,aw as te,aE as de,_ as pe,aQ as K}from"./framework.BMMljfWr.js";import{aP as he,t as x,b as fe,ct as ve,cu as le,cv as me}from"./lib.DTykjivu.js";import"./commonjsHelpers.Cpj98o6Y.js";const j=(t,_)=>{const m=w(!1),g=w(""),S=w(""),F=w(!1),u=w({matchCase:!1,matchWholeWord:!1,useWildcards:!1,matchDiacritics:!1,matchHalfFullWidth:!1}),C=w({current:0,total:0}),i=w([]),a=w(-1),E=X(()=>!g.value),T=X(()=>!g.value||C.value.total===0),I=()=>{if(!g.value)return[];const l=[];let d=t.mText.textString;if(!d)return[];let n=d,r=g.value;if(u.value.matchCase||(n=d.toLowerCase(),r=g.value.toLowerCase()),u.value.matchHalfFullWidth||(n=M(n),r=M(r)),u.value.matchDiacritics||(n=N(n),r=N(r)),u.value.useWildcards)return z(n,r);let o=0,p;for(;(p=n.indexOf(r,o))!==-1;){if(u.value.matchWholeWord){const G=p>0?n[p-1]:null,J=p+r.length<n.length?n[p+r.length]:null,ae=!G||!/\w/.test(G),se=!J||!/\w/.test(J);if(!(ae&&se)){o=p+1;continue}}l.push({index:p,length:r.length}),o=p+1}return l},M=l=>l.replace(/[\uFF01-\uFF5E]/g,d=>String.fromCharCode(d.charCodeAt(0)-65248)),N=l=>l.normalize("NFD").replace(/[\u0300-\u036f]/g,""),z=(l,d)=>{const n=[];let r=d.replace(/\*/g,".*").replace(/\?/g,".").replace(/\./g,"\\.");const o=new RegExp(r,"g");let p;for(;(p=o.exec(l))!==null;)n.push({index:p.index,length:p[0].length}),p.index===o.lastIndex&&o.lastIndex++;return n},D=l=>{t.selectionStart=l.index,t.selectionEnd=l.index+l.length,t.isSelecting=!0,t.cursorPosition=l.index+l.length,t.updateCursorPosition(),t.updateSelectionHighlight(),t.cursor.focus()},A=()=>{g.value&&(V(),i.value.length!==0&&(a.value===-1||a.value>=i.value.length-1?a.value=0:a.value++,C.value.current=a.value+1,D(i.value[a.value])))},O=()=>{g.value&&(V(),i.value.length!==0&&(a.value===-1||a.value<=0?a.value=i.value.length-1:a.value--,C.value.current=a.value+1,D(i.value[a.value])))},W=l=>{if(!g.value||l.length===0)return 0;const d=t.mText.textString,n=[...l].sort((o,p)=>p.index-o.index);t.saveToHistory();let r=d;for(const o of n)r=r.substring(0,o.index)+S.value+r.substring(o.index+o.length);return t.mText.textString=r,t.updateBox(),t.clearSelection(),a.value=-1,i.value=[],V(),fe.getCurrentMxCAD().updateDisplay(),n.length},L=()=>{if(a.value===-1||i.value.length===0)return;const l=i.value[a.value];W([l]),i.value.length>0&&A()},$=()=>{if(i.value.length===0)return;const l=W(i.value);l>0&&console.log(x(`已替换 ${l} 处文本`))},H=()=>{a.value=-1,i.value=[],C.value={current:0,total:0},t.clearSelection()},V=he(()=>{H(),g.value&&(i.value=I(),C.value.total=i.value.length,F.value=!0,i.value.length>0&&(a.value=0,C.value.current=1,D(i.value[0])))},300),k=()=>{if(t.hasSelection()){const l=t.getSelectedText();l&&(g.value=l)}m.value=!0,setTimeout(()=>{V()},100)},c=()=>{m.value=!1,t.clearSelection(),H(),_!=null&&_.onClose&&_.onClose()};return{isShow:m,findText:g,replaceText:S,optionsRef:u,resultStats:C,hasSearched:F,disableFind:E,disableReplace:T,findNext:A,findPrevious:O,replaceCurrent:L,replaceAll:$,refreshSearch:V,showDialog:(l=!0)=>{l?k():c()},closeDialog:c}},ge={class:"find-replace-header",id:"single_line_text_find_replace_dialog_header"},xe={class:"dialog-title"},_e={class:"find-replace-content"},we={class:"input-row find-row"},Ce={class:"label"},be={class:"input-row replace-row"},ye={class:"label"},Se={class:"options-area"},De={class:"option-row"},Ve={class:"option-row"},ke={class:"option-row"},Fe={class:"option-row"},We={class:"option-row"},Te={class:"right-buttons"},Re={key:0,class:"search-stats mt-2"},Ee={key:1,class:"search-stats mt-2 error-text"},Me=ie({__name:"index",props:{editor:{},onClose:{type:Function}},setup(t,{expose:_}){const m=t,{isShow:g,findText:S,replaceText:F,optionsRef:u,resultStats:C,hasSearched:i,disableFind:a,disableReplace:E,findNext:T,findPrevious:I,replaceCurrent:M,replaceAll:N,showDialog:z,closeDialog:D,refreshSearch:A}=j(m.editor,{onClose:m.onClose}),O=w(null),W=w(null),L=k=>{k.key==="Escape"?D():k.key==="Enter"&&k.ctrlKey&&T()},$=w(0),H=w(0),V=()=>{setTimeout(()=>{W.value&&W.value.focus({preventScroll:!0})})};return Y([S,()=>u.value],()=>{A(),V()},{deep:!0}),Y(g,k=>{k?(document.addEventListener("keydown",L),V()):document.removeEventListener("keydown",L)}),_({showDialog:z}),(k,c)=>{const q=P("v-img"),l=P("v-icon"),d=P("v-btn"),n=P("v-checkbox"),r=ce("draggable");return U(),re(de,{to:"body"},[e(g)?ue((U(),Q("div",{key:0,ref_key:"dialogRef",ref:O,class:"find-replace-dialog",onKeydown:c[7]||(c[7]=ee((...o)=>e(D)&&e(D)(...o),["esc"]))},[h("div",ge,[h("div",xe,[f(q,{src:e(ve)(),alt:"logo",width:"24",height:"24",class:"mr-2"},null,8,["src"]),h("span",null,b(e(x)("查找和替换")),1)]),f(d,{icon:"",size:"x-small",variant:"text",onClick:e(D),class:"close-btn"},{default:y(()=>[f(l,{icon:"cha",size:"small"})]),_:1},8,["onClick"])]),h("div",_e,[h("div",we,[f(e(le),{modelValue:e(S),"onUpdate:modelValue":c[0]||(c[0]=o=>te(S)?S.value=o:null),onKeyup:ee(e(T),["enter"]),ref_key:"findInputRef",ref:W},{prepend:y(()=>[h("label",Ce,b(e(x)("查找(N)"))+":",1)]),append:y(()=>[f(d,{onClick:e(T),width:"80",height:"21",disabled:e(a)},{default:y(()=>[B(b(e(x)("下一个")),1)]),_:1},8,["onClick","disabled"])]),_:1},8,["modelValue","onKeyup"])]),h("div",be,[f(e(le),{modelValue:e(F),"onUpdate:modelValue":c[1]||(c[1]=o=>te(F)?F.value=o:null)},{prepend:y(()=>[h("label",ye,b(e(x)("替换为(P)"))+":",1)]),append:y(()=>[f(d,{onClick:e(M),width:"80",height:"21",disabled:e(E)},{default:y(()=>[B(b(e(x)("替换(R)")),1)]),_:1},8,["onClick","disabled"])]),_:1},8,["modelValue"])]),h("div",Se,[h("div",De,[f(n,{modelValue:e(u).matchCase,"onUpdate:modelValue":c[2]||(c[2]=o=>e(u).matchCase=o),label:e(x)("区分大小写(M)")},null,8,["modelValue","label"])]),h("div",Ve,[f(n,{modelValue:e(u).matchWholeWord,"onUpdate:modelValue":c[3]||(c[3]=o=>e(u).matchWholeWord=o),label:e(x)("全字匹配(W)")},null,8,["modelValue","label"])]),h("div",ke,[f(n,{modelValue:e(u).useWildcards,"onUpdate:modelValue":c[4]||(c[4]=o=>e(u).useWildcards=o),label:e(x)("使用通配符(U)")},null,8,["modelValue","label"])]),h("div",Fe,[f(n,{modelValue:e(u).matchDiacritics,"onUpdate:modelValue":c[5]||(c[5]=o=>e(u).matchDiacritics=o),label:e(x)("区分变音符号(C)")},null,8,["modelValue","label"])]),h("div",We,[f(n,{modelValue:e(u).matchHalfFullWidth,"onUpdate:modelValue":c[6]||(c[6]=o=>e(u).matchHalfFullWidth=o),label:e(x)("区分半/全角(东亚语言)(S)")},null,8,["modelValue","label"])])]),h("div",Te,[f(d,{onClick:e(I),width:"80",height:"21",disabled:e(a),class:"mb-2"},{default:y(()=>[B(b(e(x)("上一个")),1)]),_:1},8,["onClick","disabled"]),f(d,{onClick:e(N),width:"80",height:"21",disabled:e(E)},{default:y(()=>[B(b(e(x)("全部替换(A)")),1)]),_:1},8,["onClick","disabled"]),e(C).total>0?(U(),Q("div",Re,b(e(C).current)+" / "+b(e(C).total),1)):e(S)&&e(i)?(U(),Q("div",Ee,b(e(x)("未找到匹配项")),1)):Z("",!0)])])],32)),[[r,{downEl:"#single_line_text_find_replace_dialog_header",x:$.value,y:H.value}]]):Z("",!0)])}}}),oe=pe(Me,[["__scopeId","data-v-e620346f"]]);let s,v,R=!1;function Ne(){try{return me()||null}catch(t){return console.error("获取应用实例失败:",t),null}}const Ae=t=>{try{if(R&&s&&s.component){const m=s.component;m&&m.exposed&&m.exposed.showDialog(!0);return}ne();const _=Ne();v||(v=document.createElement("div"),document.body.appendChild(v)),s=f(oe,{...t}),_&&_._context&&(s.appContext=_._context),v&&(K(s,v),R=!0,setTimeout(()=>{if(s&&s.component){const m=s.component;m&&m.exposed&&m.exposed.showDialog(!0)}},0))}catch(_){console.error("显示单行文本查找替换对话框时出错:",_)}},ne=()=>{try{if(s&&s.component){const t=s.component;t&&t.exposed&&t.exposed.showDialog(!1),t.props&&typeof t.props.onClose=="function"&&t.props.onClose(),setTimeout(()=>{v&&(K(null,v),R=!1)},300)}}catch(t){if(console.error("隐藏单行文本查找替换对话框时出错:",t),v){try{K(null,v)}catch{}R=!1}}},Le=()=>{try{v&&(s&&s.component&&(s.component.exposed&&s.component.exposed.showDialog(!1),s.component.props&&typeof s.component.props.onClose=="function"&&s.component.props.onClose()),K(null,v),v.parentNode&&v.parentNode.removeChild(v),v=void 0,s=void 0,R=!1)}catch(t){console.error("清理单行文本查找替换对话框资源时出错:",t)}},Be={SingleLineFindReplaceDialog:oe,useSingleLineFindReplace:j,create:t=>j(t),show:Ae,hide:ne,cleanup:Le};export{oe as SingleLineFindReplaceDialog,Le as cleanup,Be as default,ne as hideSingleLineFindReplaceDialog,Ae as showSingleLineFindReplaceDialog,j as useSingleLineFindReplace};
