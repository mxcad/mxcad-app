import{d as Fe,h as P,v as ee,k as Pe,D as k,aA as Ee,b as L,o as b,w as u,c as T,e as X,m as D,H as r,p as c,a as w,t as z,az as Ne,F as Y,C as te,n as ae,O as Te,a0 as ze,L as W,aw as Ae,_ as Ue}from"./framework.BMMljfWr.js";import{a4 as Le,a3 as Re,i as Be,t as a,aG as J,ax as K,aS as Ge,ay as oe,aV as q,au as We,K as p,aW as S,b as I,m as E,F as Ie,af as je,d as He,f as se,a1 as $e,j as Oe,k as Xe,v as Ye,G as Je,M as Ke}from"./lib.DTykjivu.js";import{i as le}from"./identificationFrame.zsH5ntAb.js";import"./commonjsHelpers.Cpj98o6Y.js";const qe={key:0,class:"d-flex align-center"},Qe={class:"d-flex"},Ze={class:"position-relative"},et={class:"d-flex align-center justify-space-between"},tt={class:"ml-2 multi-select-actions"},at={class:"d-flex flex-wrap justify-space-start overflow-y-auto",style:{"max-height":"340px"}},ot=["onClick"],st={class:"cut-box-actions"},lt={class:"cut-box-jump"},nt={key:0,class:"cut-box-filename"},rt={class:"cut-box-add ma-2"},it=Fe({__name:"index",setup(ct){const ne=[{name:"全部导出",primary:!0,fun:()=>ve()},{name:"关闭",fun:()=>{d.value=[],S(!1)}}],V=P(!1);ee(V,t=>{t||d.value.forEach(e=>{e.selected=!1})});const re=[{name:"批量删除",icon:"delete",color:"error",fun:de},{name:"批量导出",icon:"lingcunweiDWG",color:"primary",fun:pe}],h=P(!1),d=P([]),ie=()=>d.value.filter(t=>t.selected).length;function ce(t){if(!V.value)return;const e=d.value[t];e.selected=!e.selected,h.value=!1}ee(V,()=>{h.value=!1});function ue(){const t=d.value.some(e=>!e.selected);d.value.forEach(e=>{e.selected=t}),h.value=!1}function de(){d.value=d.value.filter(t=>!t.selected),h.value=!1}async function pe(){if(d.value.length===0){p().error(a("请先添加剪切区域"));return}const t=d.value.map((o,l)=>o.selected?l:-1).filter(o=>o!==-1),e=[];for(const o of t){d.value[o].exportStatus="ready";const l=await $(o);h.value=!1,await new Promise(n=>setTimeout(n,500)),l&&e.push(o)}e.length===0?p().error(a("导出失败")):p().success(a("选中项导出成功")),h.value=!1}function me(t){const e=d.value[t];if(!e)return;const o=parseFloat(e.param.bd_pt1_x),l=parseFloat(e.param.bd_pt1_y),n=parseFloat(e.param.bd_pt2_x),i=parseFloat(e.param.bd_pt2_y),m=Math.abs(n-o),_=Math.abs(i-l),v=.2,f=o-m*v,g=l-_*v,x=n+m*v,y=i+_*v;S(!1);const U=I.getCurrentMxCAD();U.zoomW(new E(f,g),new E(x,y));const s=U.mxdraw.getTempMarkDraw();s.clear();const C=new THREE.Vector3(o,l,0),M=new THREE.Vector3(n,l,0),G=new THREE.Vector3(n,i,0),Ve=new THREE.Vector3(o,i,0),De=Ie.createLines([C,M,G,Ve,C],16711680);s.drawEntity(De),U.updateDisplay(),setTimeout(()=>{p().warning(a("点击鼠标左键返回")),document.addEventListener("click",()=>{s.clear(),S(!0)},{once:!0})})}const N=P("manual"),F=P("");function fe(t){d.value.splice(t,1),h.value=!1}const R=P(!1),j=async(t,e)=>new Promise((o,l)=>{let n=I.getCurrentMxCAD();n.setAttribute({ShowCoordinate:!1});let i=Math.abs(t.x-e.x),m=Math.abs(t.y-e.y);if(i<1||m<1)return o(void 0);const _=800;let v,f;i<=_?(v=i,f=m):(v=_,f=_*(m/i)),n.mxdraw.createCanvasImageData(g=>{o(g),n.setAttribute({ShowCoordinate:!0})},{width:v,height:f,range_pt1:t.toVector3(),range_pt2:e.toVector3()})});function xe(t){return d.value.some(e=>{const l=Math.abs(parseFloat(e.param.bd_pt1_x)-parseFloat(t.bd_pt1_x))<.001,n=Math.abs(parseFloat(e.param.bd_pt1_y)-parseFloat(t.bd_pt1_y))<.001,i=Math.abs(parseFloat(e.param.bd_pt2_x)-parseFloat(t.bd_pt2_x))<.001,m=Math.abs(parseFloat(e.param.bd_pt2_y)-parseFloat(t.bd_pt2_y))<.001;return l&&n&&i&&m})}function H(t,e){if(xe(e)){p().info(a("已过滤重复的剪切区域"));return}d.value.push({imgBase64:t,param:e,exportStatus:"ready",selected:!1}),h.value=!0}const B=P(""),$=async t=>{if(t<0||t>=d.value.length)return;I.getCurrentMxCAD().mxdraw.getTempMarkDraw().clear();const o=d.value[t];o.exportStatus="exporting";{let{baseUrl:l="",mxfilepath:n="",cutDwgUrl:i=""}=je()||{};const m=`${new Date().getTime()}_${t}.dwg`;try{await new Promise((_,v)=>{I.getCurrentMxCAD().saveFileToUrl(i,(f,g)=>{try{let x=JSON.parse(g);if(x.ret=="ok"){let y=l+n+x.file;He.downloadFileFromUrl(y,m),o.exportStatus="success",o.fileName=m,_()}else console.error("导出DWG失败:",g),o.exportStatus="error",v(new Error(g))}catch(x){console.error("导出DWG错误:",x),o.exportStatus="error",v(x)}},void 0,JSON.stringify(o.param))})}catch(_){console.error("导出过程中发生错误:",_),o.exportStatus="error"}}},ve=async()=>{if(d.value.length===0){p().error(a("请先添加剪切区域"));return}const t=[];for(let e=0;e<d.value.length;e++){d.value[e].exportStatus="ready";const o=await $(e);h.value=!1,await new Promise(l=>setTimeout(l,500)),o&&t.push(e)}t.length===0?p().error(a("导出失败")):p().success(a("全部导出成功")),h.value=!1};function O(t,e=1){const o=e,l=e,n=new E(t.minPt.x-o,t.minPt.y-l,t.minPt.z),i=new E(t.maxPt.x+o,t.maxPt.y+l,t.maxPt.z);return{minPt:n,maxPt:i}}const _e=async()=>{const t=await le({method:"polyline",isSpecifiedRange:!R.value,layerName:Q()});if(t.length===0){p().error(a("未找到符合条件的图框"));return}for(const e of t){if(!e)continue;const o=O(e),{minPt:l,maxPt:n}=o,i=await j(l,n);if(!i)continue;const m={bd_pt1_x:""+l.x,bd_pt1_y:""+l.y,bd_pt2_x:""+n.x,bd_pt2_y:""+n.y};H(i,m)}},A=P(""),Q=()=>A.value!==""?A.value:void 0,{list:ge}=Le(Re()),ye=Pe(()=>ge.value.map(t=>t.name));async function be(){S(!1);try{const t=new se;t.setMessage(a("选择对象获取图层名:"));const e=await t.go();if(!e.isValid()){p().warning(a("未选中任何对象"));return}const o=e.getMcDbEntity();if(!o){p().warning(a("无法获取对象"));return}const l=o.layer;if(!l){p().warning(a("无法获取对象的图层名"));return}A.value=l,p().success(a("已获取图层名: ")+l)}catch(t){console.error("获取图层名失败:",t),p().error(a("获取图层名失败"))}finally{S(!0)}}async function we(){S(!1);try{const t=new se;t.setMessage(a("选择图块获取名称:"));const e=await t.go();if(!e.isValid()){p().warning(a("未选中任何对象"));return}const o=e.getMcDbEntity();if(!o){p().warning(a("无法获取对象"));return}if(o instanceof $e){const n=o.blockName;if(!n){p().warning(a("无法获取图块名称"));return}F.value=n,p().success(a("已获取图块名: ")+n)}else p().warning(a("所选对象不是图块"))}catch(t){console.error("获取图块名失败:",t),p().error(a("获取图块名失败"))}finally{S(!0)}}const he=async()=>{if(F.value===""){p().error(a("请输入图块名称"));return}const t=await le({method:"block",blockName:F.value!==""?F.value:void 0,isSpecifiedRange:!R.value,layerName:Q()});if(t.length===0){p().error(a("未找到符合条件的图框"));return}for(const e of t){if(!e)continue;const o=O(e),{minPt:l,maxPt:n}=o,i=await j(l,n);if(!i)continue;const m={bd_pt1_x:""+l.x,bd_pt1_y:""+l.y,bd_pt2_x:""+n.x,bd_pt2_y:""+n.y};H(i,m)}};async function ke(){if(N.value==="block"&&F.value===""){p().error(a("请输入图块名称"));return}S(!1);try{switch(N.value){case"polyline":await _e();break;case"block":await he();break;case"manual":default:await Ce();break}}finally{S(!0)}}async function Ce(){let t=new Oe;t.clearLastInputPoint(),t.setMessage(a(" 指定输出范围第一点:"));let e=await t.go();if(!e)return;t.setMessage(a(" 指定输出范围第二点:")),t.setUserDraw((f,g)=>{g.setColor(16711680);let x=new Xe;x.addVertexAt(e),x.addVertexAt(new E(e.x,f.y)),x.addVertexAt(f),x.addVertexAt(new E(f.x,e.y)),x.constantWidth=Ye.screenCoordLong2Doc(2),x.isClosed=!0,g.drawMcDbEntity(x);let y=[];y.push(e.toVector3()),y.push(new THREE.Vector3(e.x,f.y)),y.push(f.toVector3()),y.push(new THREE.Vector3(f.x,e.y)),g.setColor(12868),g.drawSolid(y,.5)}),t.setDisableOsnap(!0),t.setDisableOrthoTrace(!0),t.setDynamicInputType(Je.kXYCoordInput);let o=await t.go();if(!o)return;const l={minPt:new E(Math.min(e.x,o.x),Math.min(e.y,o.y),Math.min(e.z,o.z)),maxPt:new E(Math.max(e.x,o.x),Math.max(e.y,o.y),Math.max(e.z,o.z))},n=O(l),{minPt:i,maxPt:m}=n;let _={bd_pt1_x:""+i.x,bd_pt1_y:""+i.y,bd_pt2_x:""+m.x,bd_pt2_y:""+m.y};const v=await j(i,m);v&&H(v,_)}const Z=()=>{F.value="",A.value="",d.value=[],S(!1)},Me={esc:Z},Se=async()=>{const t=await Ke.showDirSelectBox(B.value);t&&(B.value=t)};return(t,e)=>{const o=k("v-text-field"),l=k("v-radio"),n=k("v-radio-group"),i=k("v-checkbox"),m=k("v-combobox"),_=k("v-switch"),v=k("v-divider"),f=k("v-icon"),g=k("v-progress-circular"),x=k("v-btn"),y=k("v-tooltip"),U=Ee("scroll-bottom");return b(),L(We,{title:c(a)("DWG剪切"),modelValue:c(q),"onUpdate:modelValue":e[7]||(e[7]=s=>Ae(q)?q.value=s:null),"max-width":"610",footerBtnList:ne,keys:Me,onClickClose:Z},{default:u(()=>[c(Be)()?(b(),T("div",qe,[r(o,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=s=>B.value=s),class:"flex-grow-1 mr-2"},{prepend:u(()=>[w(z(c(a)("存储路径"))+": ",1)]),_:1},8,["modelValue"]),r(J,{small:"",onClick:Se},{default:u(()=>[w(z(c(a)("选择路径")),1)]),_:1})])):X("",!0),D("div",Qe,[r(K,{title:c(a)("剪切方式"),class:"mr-2"},{default:u(()=>[r(n,{modelValue:N.value,"onUpdate:modelValue":e[1]||(e[1]=s=>N.value=s),inline:!1},{default:u(()=>[r(l,{value:"manual",label:c(a)("手动框选")},null,8,["label"]),r(l,{value:"polyline",class:"mt-2",label:c(a)("多段线图框识别")},null,8,["label"]),r(l,{value:"block",class:"mt-2",label:c(a)("图块图框识别")},null,8,["label"])]),_:1},8,["modelValue"])]),_:1},8,["title"]),r(K,{title:c(a)("条件过滤")},{default:u(()=>[r(i,{modelValue:R.value,"onUpdate:modelValue":e[2]||(e[2]=s=>R.value=s),label:c(a)("全图匹配"),disabled:N.value==="manual"},null,8,["modelValue","label","disabled"]),r(m,{modelValue:F.value,"onUpdate:modelValue":e[3]||(e[3]=s=>F.value=s),class:"mt-2",items:c(Ge)(),disabled:N.value!=="block",clearable:""},{prepend:u(()=>[w(z(c(a)("图块名"))+": ",1)]),append:u(()=>[r(oe,{text:c(a)("选择对象获取图块名"),onClick:we},null,8,["text"])]),_:1},8,["modelValue","items","disabled"]),r(m,{class:"mt-2",modelValue:A.value,"onUpdate:modelValue":e[4]||(e[4]=s=>A.value=s),items:ye.value,disabled:N.value==="manual",clearable:""},{prepend:u(()=>[w(z(c(a)("图层名"))+": ",1)]),append:u(()=>[r(oe,{text:c(a)("选择对象获取图层名"),onClick:be},null,8,["text"])]),_:1},8,["modelValue","items","disabled"])]),_:1},8,["title"])]),r(K,{title:c(a)("剪切区域"),class:"mt-2",style:{"min-height":"420px"}},{default:u(()=>[D("div",Ze,[D("div",et,[r(_,{class:"ml-4",modelValue:V.value,"onUpdate:modelValue":e[5]||(e[5]=s=>V.value=s),label:V.value?c(a)("多选"):c(a)("单选"),density:"compact",color:"primary","hide-details":""},null,8,["modelValue","label"]),D("div",tt,[r(J,{small:"",onClick:ue,disabled:d.value.length===0||!V.value},{default:u(()=>[w(z(d.value.some(s=>!s.selected)?c(a)("全选"):c(a)("取消全选")),1)]),_:1},8,["disabled"]),(b(),T(Y,null,te(re,(s,C)=>r(J,{small:"",disabled:!(ie()>0),key:C,class:"ml-1",onClick:s.fun},{default:u(()=>[w(z(s.name),1)]),_:2},1032,["disabled","onClick"])),64))])]),r(v,{class:"mb-2"}),Ne((b(),T("div",at,[(b(!0),T(Y,null,te(d.value,(s,C)=>(b(),T("div",{key:C,class:ae(["cut-box-container ma-2",{"selected-box":s.selected}])},[D("div",{class:"cut-box bg-black",style:Te({backgroundImage:`url(${s.imgBase64})`,backgroundPosition:"center",backgroundRepeat:"no-repeat",backgroundSize:"contain"}),onClick:M=>V.value&&ce(C)},[D("div",{class:ae(["cut-box-status",[s.exportStatus==="ready"?"status-ready":s.exportStatus==="exporting"?"status-exporting":s.exportStatus==="success"?"status-success":"status-error"]])},[V.value?(b(),L(i,{key:0,style:{"--v-selection-control-size":"24px","margin-left":"2px","margin-top":"1.5px"},modelValue:s.selected,"onUpdate:modelValue":M=>s.selected=M,color:"primary",onClick:e[6]||(e[6]=ze(()=>{},["stop"]))},null,8,["modelValue","onUpdate:modelValue"])):(b(),T(Y,{key:1},[s.exportStatus==="ready"?(b(),L(f,{key:0,size:"small"},{default:u(()=>[...e[8]||(e[8]=[w("pending",-1)])]),_:1})):s.exportStatus==="exporting"?(b(),L(g,{key:1,indeterminate:"",size:"16",width:"2",color:"white"})):s.exportStatus==="success"?(b(),L(f,{key:2,color:"success",size:"small"},{default:u(()=>[...e[9]||(e[9]=[w("class:iconfont gou",-1)])]),_:1})):X("",!0)],64))],2),D("div",st,[r(y,{text:c(a)("删除"),location:"top"},{activator:u(({props:M})=>[r(x,W({ref_for:!0},M,{icon:"",variant:"outlined",color:"error",class:"delete-btn",onClick:G=>fe(C)}),{default:u(()=>[r(f,{size:"14"},{default:u(()=>[...e[10]||(e[10]=[w("cha",-1)])]),_:1})]),_:1},16,["onClick"])]),_:2},1032,["text"]),r(y,{text:s.exportStatus==="ready"?c(a)("导出DWG"):s.exportStatus==="exporting"?c(a)("导出中..."):s.exportStatus==="success"?c(a)("重新导出"):c(a)("导出失败，点击重试"),location:"top"},{activator:u(({props:M})=>[r(x,W({ref_for:!0},M,{icon:"",variant:"outlined",color:s.exportStatus==="success"?"success":s.exportStatus==="error"?"warning":"primary",class:"export-btn",disabled:s.exportStatus==="exporting",loading:s.exportStatus==="exporting",onClick:G=>$(C)}),{default:u(()=>[r(f,{size:"14"},{default:u(()=>[...e[11]||(e[11]=[w("lingcunweiDWG",-1)])]),_:1})]),_:1},16,["color","disabled","loading","onClick"])]),_:2},1032,["text"])]),D("div",lt,[r(y,{text:c(a)("跳转到此区域"),location:"top"},{activator:u(({props:M})=>[r(x,W({ref_for:!0},M,{icon:"",variant:"outlined",color:"info",class:"jump-btn",onClick:G=>me(C)}),{default:u(()=>[r(f,{size:"14"},{default:u(()=>[...e[12]||(e[12]=[w("chuangkousuofang",-1)])]),_:1})]),_:1},16,["onClick"])]),_:2},1032,["text"])])],12,ot),s.fileName?(b(),T("div",nt,z(s.fileName),1)):X("",!0)],2))),128)),D("div",rt,[r(y,{text:c(a)("添加剪切区域"),location:"top"},{activator:u(({props:s})=>[r(x,W({class:"add-btn"},s,{variant:"outlined",color:"primary",onClick:ke}),{default:u(()=>[r(f,{size:"36"},{default:u(()=>[...e[13]||(e[13]=[w("class:iconfont plus",-1)])]),_:1})]),_:1},16)]),_:1},8,["text"])])])),[[U,h.value]])])]),_:1},8,["title"])]),_:1},8,["title","modelValue"])}}}),ft=Ue(it,[["__scopeId","data-v-a3fc4717"]]);export{ft as default};
