import{z as k,t as b,a1 as x,K as h,P as g,p as R,m as M,k as P,bm as B}from"./lib.Cdm3KEls.js";function p(a){a.sort((i,o)=>i.minPt.y===o.minPt.y?i.minPt.x-o.minPt.x:i.minPt.y-o.minPt.y);let r=[];for(const i of a){let o=!0;for(const s of r)if(i.minPt.x>=s.minPt.x&&i.minPt.y>=s.minPt.y&&i.maxPt.x<=s.maxPt.x&&i.maxPt.y<=s.maxPt.y){o=!1;break}o&&r.push(i)}return r}const E=async a=>{const{blockName:r,isSpecifiedRange:i=!1,layerName:o}=a||{},s=[];let m=r;if(!m){const l=await k.userSelect(b("选择图块图框"));if(l.length===0)return s;const u=l[0].getMcDbEntity();if(!(u instanceof x))return h().error(b("请选择一个图块")),s;const e=u.blockTableRecordId.getMcDbBlockTableRecord();if(!e)return s;m=e.name}const y=new g,f=new R;return f.AddMcDbEntityTypes("INSERT"),i?await y.userSelect(b("识别图框的范围"),f):y.allSelect(f),y.forEach(l=>{const u=l.getMcDbEntity();if(u instanceof x){const t=u,e=t.blockTableRecordId.getMcDbBlockTableRecord();if(o&&t.layer!==o)return;if(e&&e.name===m){const{minPt:n,maxPt:c}=t.getBoundingBox(),d=new M(Math.min(n.x,c.x),Math.min(n.y,c.y),Math.min(n.z,c.z)),D=new M(Math.max(n.x,c.x),Math.max(n.y,c.y),Math.max(n.z,c.z));s.push({minPt:d,maxPt:D})}}}),s},S=async a=>{const{isSpecifiedRange:r=!0,layerName:i}=a||{};let o=[];if(r)o=await k.userSelect(b("请选择图框"));else{const t=new g,e=new R;e.AddMcDbEntityTypes("LWPOLYLINE"),t.allSelect(e),o=t.getIds()}const s=[],m=(t,e,n)=>(e.x-t.x)*(e.x-n.x)+(e.y-t.y)*(e.y-n.y)==0,y=(t,e,n,c)=>m(t,e,n),f=t=>{if(t instanceof P){if(i&&t.layer!==i)return;const e=t.numVerts();if(e===0||(t.isClosed?e>4:e>5))return;for(let c=0;c<e;c++)if(t.getBulgeAt(c)>.001)return;const n=t.getPointAt(0).val;if(y(n,t.getPointAt(1).val,t.getPointAt(2).val,t.isClosed?n:t.getPointAt(3).val)){const{minPt:c,maxPt:d}=t.getBoundingBox();s.push({minPt:c,maxPt:d})}}},l=t=>{const e=t.blockTableRecordId.getMcDbBlockTableRecord();e&&e.getAllEntityId().forEach(n=>{const c=n.getMcDbEntity();c&&(c instanceof P&&f(c),c instanceof x&&l(c))})};return o.forEach(t=>{const e=t.getMcDbEntity();if(e instanceof P)f(e);else if(e instanceof x){if(i&&e.layer!==i)return;l(e)}}),p(s).filter(({minPt:t,maxPt:e})=>{const n=new g;return n.imp.userSelect(t.x,t.y,e.x,e.y,B(),!1),n.count()!==0})},T=async a=>{const{method:r="polyline",blockName:i,isSpecifiedRange:o,layerName:s}=a||{};return r==="block"?E({blockName:i,isSpecifiedRange:o,layerName:s}):S({isSpecifiedRange:o,layerName:s})};export{T as i};
