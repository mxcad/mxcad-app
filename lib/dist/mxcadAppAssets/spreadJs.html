<!DOCTYPE html>
<html style="height: 100%">

<style>
    html,
    body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    .spreadjs-report-tutorial {
        width: 100%;
        height: 100%;
    }

    #demo-host {
        width: 100%;
        height: 100%;
    }
</style>

<head>
    <meta charset="utf-8" />
    <title>自定义表格展示</title>

    <script type="text/javascript"
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets/dist/gc.spread.sheets.all.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-shapes/dist/gc.spread.sheets.shapes.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-charts/dist/gc.spread.sheets.charts.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-print/dist/gc.spread.sheets.print.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-pdf/dist/gc.spread.sheets.pdf.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-reportsheet-addon/dist/gc.spread.report.reportsheet.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-resources-zh/dist/gc.spread.sheets.resources.zh.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-designer-resources-cn/dist/gc.spread.sheets.designer.resource.cn.min.js"></script>
    <script
        src="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-designer/dist/gc.spread.sheets.designer.all.min.js"></script>
    <link
        href="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets/styles/gc.spread.sheets.excel2013white.css"
        rel="stylesheet" type="text/css" />
    <link
        href="https://cdn.grapecity.com.cn/SpreadJS/package-contents/18.0.3/spread-sheets-designer/styles/gc.spread.sheets.designer.min.css"
        rel="stylesheet" type="text/css" />

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
        }

        #spreadContainer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <!-- SpreadJS 表格容器 -->
    <div class="spreadjs-report-tutorial">
        <div id="demo-host"></div>
    </div>

    <script>
        // 数据类型定义
        const DataType = {
            standalone: 0,
            merged: 1
        };

        // 解析单元格名，如 A1 -> {row: 0, col: 0}
        function parseCellRef(cellName) {
            const match = cellName.trim().match(/^([A-Z]+)(\d+)$/);
            if (!match) throw new Error(`无效单元格引用: ${cellName}`);
            const colStr = match[1];
            const rowStr = match[2];
            let col = 0;
            for (let i = 0; i < colStr.length; i++) {
                col = col * 26 + (colStr.charCodeAt(i) - 64);
            }
            return { row: parseInt(rowStr, 10) - 1, col: col - 1 };
        }

        // 页面加载完成后初始化表格
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const data = JSON.parse(urlParams.get('tableData'));
            const designer = new GC.Spread.Sheets.Designer.Designer(document.getElementById("demo-host"));
            const spread = designer.getWorkbook();
            const sheet = spread.getActiveSheet();

            // 设置默认样式
            sheet.options.editable = false; // 禁止编辑
            sheet.options.showDragFillHandler = false;

            const parsedMerges = [];

            // 遍历数据并渲染
            data.forEach(item => {
                if (item.type === DataType.merged) {
                    // 处理合并单元格
                    const cells = item.name.split(' ').map(parseCellRef);
                    const rows = cells.map(c => c.row);
                    const cols = cells.map(c => c.col);
                    const startRow = Math.min(...rows);
                    const endRow = Math.max(...rows);
                    const startCol = Math.min(...cols);
                    const endCol = Math.max(...cols);
                    const rowSpan = endRow - startRow + 1;
                    const colSpan = endCol - startCol + 1;

                    // 添加合并
                    sheet.addSpan(startRow, startCol, rowSpan, colSpan);
                    sheet.setValue(startRow, startCol, item.content);

                    // 设置样式
                    const cell = sheet.getCell(startRow, startCol);
                    cell.hAlign(GC.Spread.Sheets.HorizontalAlign.center);
                    cell.vAlign(GC.Spread.Sheets.VerticalAlign.center);
                    cell.wordWrap(true);

                    // 记录已合并区域
                    parsedMerges.push({ startRow, startCol, endRow, endCol });

                } else if (item.type === DataType.standalone) {
                    // 普通单元格
                    const { row, col } = parseCellRef(item.name);
                    // 检查是否被合并区域占用
                    const isOverlapped = parsedMerges.some(merge =>
                        row >= merge.startRow && row <= merge.endRow &&
                        col >= merge.startCol && col <= merge.endCol
                    );
                    if (!isOverlapped) {
                        sheet.setValue(row, col, item.content);
                        const cell = sheet.getCell(row, col);
                        cell.hAlign(GC.Spread.Sheets.HorizontalAlign.center);
                        cell.vAlign(GC.Spread.Sheets.VerticalAlign.center);
                        cell.wordWrap(true);
                    }
                }
            });

            // 添加边框（仅对有内容的单元格）
            const border = new GC.Spread.Sheets.LineBorder('black', GC.Spread.Sheets.LineStyle.thin);
            data.forEach(item => {
                item.name.split(' ').forEach(name => {
                    const { row, col } = parseCellRef(name);
                    const cell = sheet.getCell(row, col);
                    cell.wordWrap(true);
                    // 仅对非合并区域的起始单元格或独立单元格加边框
                    if (cell.value() !== undefined) {
                        cell.borderTop(border);
                        cell.borderLeft(border);
                        cell.borderRight(border);
                        cell.borderBottom(border);
                    }
                });
            });

            // 自动调整列宽,行高（可选）
            const rowCount = sheet.getRowCount();
            for (let row = 0; row < rowCount; row++) {
                sheet.autoFitRow(row)
            }
            const columnCount = sheet.getColumnCount();
            for (let col = 0; col < columnCount; col++) {
                sheet.autoFitColumn(col);
            }
        };
    </script>
</body>

</html>